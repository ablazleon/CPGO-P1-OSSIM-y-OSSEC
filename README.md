# CPGO-P1-OSSIM-y-OSSEC

Autores:

- Jose Miguel Del Valle Salas
- Adrián Blázquez León

En este repo, documentamos cómo hemos planteado realizar esta práctica

# 1- Configurar escenario
# 2- Prueba de funcionamiento del escenario
# 3- Creación de directivas de correlación
# 4- Configuración de agentes de operación

1- Configurar escenario

## a. Configurar las direcciones IPs correspondientes tanto en la maquina agente como en la maquina servidor, para que tengan conectividad entre si.

## b. Descargar el agente ossec para la maquina agente y realizar la configuración entre el agente y el servidor OSSEC para permitir el envío de logs

## c. Configurar correctamente el agente OSSEC en su correspondiente fichero de configuración, (indicando el formato de logs que debe monitorizar), y la ubicación del fichero fast.log donde Suricata deposita las alertas de las alarmas. (Sugerencia)Reiniciar el servidor ossec como el agente ossec, cada vez que se realice cambios.

---------------

## a. Configurar las direcciones IPs correspondientes tanto en la maquina agente como en la maquina servidor, para que tengan conectividad entre si.

Primero, pensamos en crear una subred interna para conectar el agente con OSSIM, insparándonos en la estrategia de este [tutorial](https://www.brianlinkletter.com/2016/07/how-to-use-virtualbox-to-emulate-a-network/#:~:text=To%20connect%20two%20virtual%20machines,the%20Router%2D1%20virtual%20machine). Luego, intentamos directametne conectar las dos máquinas a la red local.

- Se cambia la ip del adaptador ethernet de la máquina real:

192.168.56.101
Servidor de dns:212.166.210.80

- Se cambia la ip del agente:

192.168.1.103
255.255.255.0
192.168.1.101:gw

Para que entre en fucnionamiento el adpatador se apaga y se enciende.

- Se cambia la ip del servidor:

Gateway: 192.168.1.101

Name server address: 192.168.1.102

Para configurar en bridge: settings => network => bridge

Se realiza un ping y se abre el dashboard de ossim en el agetne, para comprobar que existe conectividad.

## b. Descargar el agente ossec para la maquina agente y realizar la configuración entre el agente y el servidor OSSEC para permitir el envío de logs

- jailbreak teh system and add an agent

https://www.ossec.net/docs/manual/agent/index.html

```
Starting shell
alienvault:~# /var/ossec/bin/manage_agents 


****************************************
* OSSEC HIDS v2.9.1 Agent manager.     *
* The following options are available: *
****************************************
   (A)dd an agent (A).
   (E)xtract key for an agent (E).
   (L)ist already added agents (L).
   (R)emove an agent (R).
   (Q)uit.
Choose your action: A,E,L,R or Q: e

Available agents: 
   ID: 001, Name: ubuntu18, IP: 192.168.56.102
Provide the ID of the agent to extract the key (or '\q' to quit): 001

Agent key information for '001' is: 
MDAxIHVidW50dTE4IDE5Mi4xNjguNTYuMTAyIDhkMjJjYzY4YjQwZTc5ZmQ4MzZmNzVkZTNhODRlOGY0NDRkNDY5ZmUzN2UzMjFjMDcwY2MwNWY3MGU3MTc2MGE=

** Press ENTER to return to the main menu.
```
- configure the agent

```
# Add Apt sources.lst
wget -q -O - https://updates.atomicorp.com/installers/atomic | sudo bash

 # Update apt data
 sudo apt-get update

# Agent
sudo apt-get install ossec-hids-agent
```

```
sudo /var/ossec/bin/manage_agents


****************************************
* OSSEC HIDS v3.6.0 Agent manager.     *
* The following options are available: *
****************************************
   (I)mport key from the server (I).
   (Q)uit.
Choose your action: I or Q: I

* Provide the Key generated by the server.
* The best approach is to cut and paste it.
*** OBS: Do not include spaces or new lines.

Paste it here (or '\q' to quit): MDAxIHVidW50dTE4IDE5Mi4xNjguNTYuMTAyIDhkMjJjYzY4YjQwZTc5ZmQ4MzZmNzVkZTNhODRlOGY0NDRkNDY5ZmUzN2UzMjFjMDcwY2MwNWY3MGU3MTc2MGE=

```

After this, it appears some error about no file in ossec/queue/rids. To solve this is repeated teh importing in the agent, afeter creating an empty file called sender

```
root@ubuntu-VirtualBox:/var/ossec# cd queue/rids/
root@ubuntu-VirtualBox:/var/ossec/queue/rids# ls
root@ubuntu-VirtualBox:/var/ossec/queue/rids# nano sender
root@ubuntu-VirtualBox:/var/ossec/queue/rids# ls
sender
root@ubuntu-VirtualBox:/var/ossec/queue/rids# cd /var/ossec/bin/manage_agents 
bash: cd: /var/ossec/bin/manage_agents: Not a directory
root@ubuntu-VirtualBox:/var/ossec/queue/rids# /var/ossec/bin/manage_agents 
```

## c. Configurar correctamente el agente OSSEC en su correspondiente fichero de configuración, (indicando el formato de logs que debe monitorizar), y la ubicación del fichero fast.log donde Suricata deposita las alertas de las alarmas. (Sugerencia)Reiniciar el servidor ossec como el agente ossec, cada vez que se realice cambios.

Al descargar suricata parece este error:

```
E: Could not get lock /var/lib/dpkg/lock-frontend - open (11: Resource temporarily unavailable)
E: Unable to acquire the dpkg frontend lock (/var/lib/dpkg/lock-frontend), is another process using it?
```

Que se soluciona así:
https://itsfoss.com/could-not-get-lock-error/

```
sudo apt-get install software-properties-common
sudo add-apt-repository ppa:oisf/suricata-stable
sudo apt-get update

sudo apt-get install suricata 
```


Then, it is changed the ip in the agent ossec:

```
root@ubuntu-VirtualBox:/var/ossec/etc# nano ossec.conf 

<!-- OSSEC example config -->

<ossec_config>
  <client>
    <server-ip>192.168.1.103</server-ip>
  </client>

```

Then, agent and server machines are reboot.

2- Prueba de funcionamiento del escenario

3- Creación de directivas de correlación

4- Configuración de agentes de operación

